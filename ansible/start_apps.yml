- hosts: big
  become: yes

  tasks:
    - name: Copy apps directory to target
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../apps/"
        dest: "/home/{{ ansible_user }}/apps/"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: preserve
    
    - name: Deploy open-webui stack
      ansible.builtin.shell: |
        export OPENAI_API_KEY="{{ openai_api_key }}"
        docker stack deploy -c docker-compose.yml open-webui
      environment:
        OPENAI_API_KEY: "{{ openai_api_key }}"
      args:
        chdir: "/home/{{ ansible_user }}/apps/open-webui"